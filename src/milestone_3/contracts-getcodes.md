# [contract-codes](https://www.rareskills.io/post/solidity-code-length)
åˆ¤æ–­æ˜¯å¦æ˜¯åˆçº¦åœ°å€çš„ä¸‰ç§æ–¹å¼
- `msg.sender==tx.origin`
- `EXTCODESIZE` è¯»å– `code.length` 
- `EXTCODEHASH` è¯»å– `code.hash`
## msg.sender==tx.origin
- `tx.origin` æ˜¯å½“å‰äº¤æ˜“çš„ç­¾ååœ°å€
- `msg.sender` æ˜¯å½“å‰ `EVM` æ‰§è¡Œç¯å¢ƒä¸­çš„äº¤æ˜“å‘é€åœ°å€
- å¯¹äº `EOA` ç›´æ¥å‘èµ·çš„çš„åˆçº¦äº¤æ˜“ï¼Œåˆçº¦å†…éƒ¨ï¼š`msg.sender==tx.origin`
- åˆçº¦ä¹‹é—´å¤–éƒ¨è°ƒç”¨é‡å¯ `EVM` æ‰§è¡Œç¯å¢ƒçš„å¤–éƒ¨è°ƒç”¨ï¼š`msg.sender!=tx.origin`
![](./images/tx-origin-sender.png)
## EXTCODESIZE
- `codeSize = 0`, ä¸è¡¨ç¤ºè¯¥åœ°å€ä¸€å®šæ˜¯ `EOA` åœ°å€
  - æœ‰å¯èƒ½æ˜¯é¢„å®šä¹‰çš„ `create2` åœ°å€ï¼Œæœªæ¥ä¼šéƒ¨ç½²æˆä¸ºåˆçº¦
  - å¯¹æ–¹åœ¨ `constructor()` ä¸­è°ƒç”¨ `call` äº¤æ˜“ï¼Œæ­¤æ—¶åˆçº¦æœªå­˜å‚¨ä¸Šé“¾ï¼Œ`codeSize = 0`
- [selfdestruct](./contracts-destroy.md)åœ¨ `dencun` å‡çº§åå¹¶ä¸ä¼šæ¸…é™¤åˆçº¦çŠ¶æ€å’Œä»£ç ï¼Œå› æ­¤ codeSize != 0
## Solidity Examples
```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

contract TestAddressSize {
    event codeSize(uint256);

    function constructorCodeSize() external {
        uint256 codes;
        address sender = msg.sender;
        assembly {
            codes := extcodesize(sender)
        }
        emit codeSize(codes);
    }

    // 765 gas
    function codesize(address target) public view returns (bool isContract) {
        if (target.code.length == 0) {
            isContract = false;
        } else {
            isContract = true;
        }
    }

    // 779 gas
    function codesizeAssm(address target) public view returns (bool) {
        uint256 size;
        assembly {
            size := extcodesize(target)
        }
        return size != 0;
    }
}

contract onlyConstructor {
    constructor() {
        address addr = 0x10E2fC1dE57DDC788489122151a6c45254D3ba59;
        (bool success, ) = addr.call(
            abi.encodeWithSignature("constructorCodeSize()")
        );
        if (!success) {
            revert();
        }
    }
    // [
    // 	{
    // 		"from": "0x10E2fC1dE57DDC788489122151a6c45254D3ba59",
    // 		"topic": "0x35bbf8dac6652434e49dd256e75001562f8cabc9ab024b4ed3f7826b3ab5a81f",
    // 		"event": "codeSize",
    // 		"args": {
    // 			"0": "0"
    // 		}
    // 	}
    // ]
}

contract afterSelfDestruct {
    function deposit() external payable {}

    // é”€æ¯åå¹¶ä¸ä¼šå½±å“åˆçº¦çš„ä½¿ç”¨
    // é”€æ¯ä¿ç•™åˆçº¦çš„çŠ¶æ€çš„ä»£ç 
    // é”€æ¯ä»…ä»…æ˜¯å¼ºåˆ¶å°†åˆçº¦ä½™é¢è½¬å‡º
    function kill() external {
        selfdestruct(payable(msg.sender));
    }
}
```
## EXTCODEHASH
- è¿”å› `keccak256(codes)`
- å¦‚æœåœ°å€ `balance == 0 && codeSize == 0`, è¿”å› `bytes32(0)`
- å¦‚æœåœ°å€ `balance != 0 && codeSize == 0`, è¿”å› `keccak256(""")=0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470`
- å¦‚æœåœ°å€ `codeSize != 0`, è¿”å› `keccak256(codes)`
- å…¨éƒ¨ [é¢„ç¼–è¯‘](../Milestone3/contracts-precompile.md)åˆçº¦é¢„å­˜ `1wei`,å› æ­¤ä¼šè¿”å›ç©ºå€¼çš„ `hash`
```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

contract TestAddressSize {
    event codeHash(bytes32);

    function constructorCodeHash() external {
        bytes32 codehashs;
        address sender = msg.sender;
        assembly {
            codehashs := extcodehash(sender)
        }
        emit codeHash(codehashs);
    }

    //  gas
    function codehash(address target) public view returns (bytes32 hash) {
        hash = target.codehash;
    }

    //  gas
    function codesizeAssm(address target) public view returns (bytes32 hash) {
        assembly {
            hash := extcodehash(target)
        }
    }
}

contract onlyConstructor {
    //0x0000000000000000000000000000000000000000000000000000000000000000
    constructor() {
        address addr = 0x16a90f9ec7A46514b47487bDc2F00d11740c3BA0;
        (bool success, ) = addr.call(
            abi.encodeWithSignature("constructorCodeSize()")
        );
        if (!success) {
            revert();
        }
    }
}

contract afterSelfDestruct {
    function deposit() external payable {}

    // before kill: 0xd0516dff3313077772b6176aa83c5ad4da898b2f66e2dd058b612dbace072fbc
    // after kill: 0xd0516dff3313077772b6176aa83c5ad4da898b2f66e2dd058b612dbace072fbc
    // é”€æ¯åå¹¶ä¸ä¼šå½±å“åˆçº¦çš„ä½¿ç”¨
    // é”€æ¯ä¿ç•™åˆçº¦çš„çŠ¶æ€çš„ä»£ç 
    // é”€æ¯ä»…ä»…æ˜¯å¼ºåˆ¶å°†åˆçº¦ä½™é¢è½¬å‡º
    function kill() external {
        selfdestruct(payable(msg.sender));
    }
}
```
## åˆ¤æ–­åœ°å€æ˜¯å¦æ˜¯åˆçº¦åœ°å€
```solidity
// SPDX-License-Identifier: MIT

pragma solidity ^0.8.0;

library ContractAddress {
    function isContract(address contractAddress) internal view returns (bool) {
        bytes32 existingCodeHash = contractAddress.codehash;

        // https://eips.ethereum.org/EIPS/eip-1052
        // keccak256('') == 0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470
        return
            existingCodeHash != bytes32(0) &&
            existingCodeHash != 0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470;
    }
}
```

## è·å–åœ°å€çš„åˆçº¦codes
```solidity
library GetCode {
    function at(address _addr) public view returns (bytes memory o_code) {
        assembly {
            // retrieve the size of the code, this needs assembly
            let size := extcodesize(_addr)
            // allocate output byte array - this could also be done without assembly
            // by using o_code = new bytes(size)
            o_code := mload(0x40)
            // new "memory end" including padding
            mstore(0x40, add(o_code, and(add(add(size, 0x20), 0x1f), not(0x1f))))
            // store length in memory
            mstore(o_code, size)
            // actually retrieve the code, this needs assembly
            extcodecopy(_addr, add(o_code, 0x20), 0, size)
        }
    }
}
```
å‡è®¾ï¼š
- _addr åœ°å€çš„ä»£ç å¤§å°æ˜¯ size = 45 å­—èŠ‚
- å½“å‰ç©ºé—²å†…å­˜æŒ‡é’ˆ mload(0x40) = 0x80

1. è·å–åˆçº¦codeçš„size
```solidity
let size := extcodesize(_addr)
```
2. è·å–å½“å‰å†…å­˜çš„ç©ºé—²ä½ç½®
```solidity
o_code := mload(0x40)
```
```scss
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœ°å€          â”‚ å†…å®¹        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x40          â”‚ 0x80        â”‚ â† å½“å‰ç©ºé—²å†…å­˜æŒ‡é’ˆ
â”‚ o_code = 0x80 â”‚ åˆ†é…èµ·ç‚¹     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
3. æ›´æ–°ç©ºé—²å†…å­˜çš„èµ·å§‹ä½ç½®ï¼ˆé˜²æ­¢æ•°æ®é‡å†™è¦†ç›–ï¼‰
```solidity
mstore(0x40, add(o_code, and(add(add(size, 0x20), 0x1f), not(0x1f))))
```
```json
size = 45
size + 0x20 = 77      â† åŠ ä¸Š bytes å¤´
+ 0x1f     = 108       â† å‘ä¸Šå¯¹é½æ‰€éœ€çš„åç§»
& ~0x1f    = 0x60     â† æ¸…é™¤ä½ 5 ä½ï¼Œå˜æˆ 32 å­—èŠ‚å¯¹é½ï¼ˆ0x60 = 96ï¼‰

new_free_ptr = o_code + 96 = 0x80 + 0x60 = 0xE0
```
```scss
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœ°å€          â”‚ å†…å®¹        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x40          â”‚ 0xE0        â”‚ â† æ›´æ–°åçš„ç©ºé—²æŒ‡é’ˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
4. å°†åˆçº¦codes sizeå†™å…¥å½“å‰è·å–çš„å†…å­˜ä½ç½®
```solidity
mstore(o_code, size)
```
```scss
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœ°å€          â”‚ å†…å®¹               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x80          â”‚ 0x2D (45 åè¿›åˆ¶)   â”‚ â† bytes é•¿åº¦å¤´
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
5. æ‹·è´ä»£ç åˆ°å†…å­˜ä¸­
```solidity
extcodecopy(_addr, add(o_code, 0x20), 0, size)
```
```scss
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœ°å€          â”‚ å†…å®¹                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x80          â”‚ 0x2D (é•¿åº¦ 45)             â”‚ â† æ•°ç»„å¤´
â”‚ 0xA0          â”‚ å­—èŠ‚ç ç¬¬1å­—èŠ‚              â”‚
â”‚ 0xA1          â”‚ å­—èŠ‚ç ç¬¬2å­—èŠ‚              â”‚
â”‚ ...           â”‚ ...                        â”‚
â”‚ 0xA0 + 2C     â”‚ å­—èŠ‚ç ç¬¬45å­—èŠ‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
6. æœ€ç»ˆå†…å­˜å¸ƒå±€
```scss
[0x80]      â† o_code
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç§»       â”‚ å†…å®¹                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x00       â”‚ length = 45                â”‚
â”‚ 0x20       â”‚ bytecode[0]                â”‚
â”‚ 0x21       â”‚ bytecode[1]                â”‚
â”‚ ...        â”‚ ...                        â”‚
â”‚ 0x4C       â”‚ bytecode[44]               â”‚
â”‚ 0xE0       â”‚ ä¸‹ä¸€ä¸ªç©ºé—²å†…å­˜æŒ‡é’ˆ         â”‚ â† å¯¹é½åæ›´æ–°åˆ° 0x40
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
### æœ€ç»ˆè·å–æ•°æ®æ˜¯ä¸ºä»€ä¹ˆ +0x20
åœ¨ Solidity ä¸­ï¼Œbytes/string åœ¨å†…å­˜ä¸­çš„å¸ƒå±€å¦‚ä¸‹ï¼š

| offset | å†…å®¹                  |
|--------|-----------------------|
| 0x00   | æ•°ç»„é•¿åº¦ï¼ˆ32 å­—èŠ‚ï¼‰   |
| 0x20   | ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼ˆdata[0])  |
| 0x21   | ç¬¬äºŒä¸ªå­—èŠ‚ï¼ˆdata[1])  |
| ...    | åç»­æ•°æ®               |

- o_code æ˜¯å†…å­˜ä¸­åŠ¨æ€å­—èŠ‚æ•°ç»„çš„èµ·å§‹åœ°å€ã€‚ 
- è¯¥åœ°å€çš„å‰ 32 å­—èŠ‚å­˜å‚¨çš„æ˜¯æ•°ç»„çš„ é•¿åº¦ï¼ˆä¹Ÿå°±æ˜¯å­—èŠ‚ç çš„å¤§å°ï¼‰ã€‚ 
- å®é™…æ•°æ®ï¼ˆbytecodeï¼‰ä» o_code + 0x20 å¼€å§‹ã€‚

å†…å­˜åˆ†é…ä¸ºï¼š
```yaml
0x80:  [  0x64 = 100 ]     â† æ•°ç»„é•¿åº¦
0xA0:  [ byte 0   ]        â† å­—èŠ‚ç å®é™…å¼€å§‹ä½ç½®
0xA1:  [ byte 1   ]
...
0xA0 + 100: [ç»“æŸ]
```
### ä¸ºä»€ä¹ˆéœ€è¦é‡æ–°å®šä¹‰ç©ºé—²å†…å­˜çš„èµ·å§‹ä½ç½®
```solidity
mstore(0x40, add(o_code, and(add(add(size, 0x20), 0x1f), not(0x1f))))
```
ğŸ§  è¿™å¥åšäº†ä»€ä¹ˆï¼Ÿ
å®ƒçš„ä½œç”¨æ˜¯ï¼š

âœ… æ›´æ–° `Solidity` çš„â€œç©ºé—²å†…å­˜æŒ‡é’ˆâ€ï¼Œä¿å­˜åœ¨ä½ç½® `0x40`ã€‚

è¿™æ˜¯ `Solidity` çš„ä¸€ä¸ªéšå¼è§„èŒƒï¼Œå‘Šè¯‰ç¼–è¯‘å™¨ä»å“ªé‡Œå¼€å§‹å®‰å…¨åœ°åˆ†é…æ–°çš„å†…å­˜ã€‚

å†…å­˜ä»åœ°å€ `0x80` å¼€å§‹ï¼Œä½ç½® `0x40` æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„åœ°æ–¹ï¼Œçº¦å®šç”¨äºå­˜å‚¨â€œä¸‹ä¸€ä¸ªç©ºé—²å†…å­˜åœ°å€â€ã€‚

ğŸ§¨ å¦‚æœä½ åˆ é™¤äº†è¿™ä¸€å¥ä¼šæ€æ ·ï¼Ÿ
ä¸ç«‹å³æŠ¥é”™ï¼Œä½†æœªæ¥å¯èƒ½é€ æˆä¸¥é‡é—®é¢˜ï¼š

âœ… å½“å‰å‡½æ•°å†…éƒ¨çœ‹èµ·æ¥å¯èƒ½æ²¡æœ‰é—®é¢˜ï¼Œå› ä¸ºä½ å·²ç»åˆ†é…å¥½äº†å†…å­˜ã€‚

âŒ ä¸€æ—¦åç»­å‡½æ•°æˆ– `Solidity` å†…éƒ¨é€»è¾‘è¦å†ç”¨ `mload(0x40)` åˆ†é…å†…å­˜ï¼Œå°±ä¼šé”™è¯¯åœ°è¦†ç›–ä½ ä¹‹å‰å†™çš„å†…å®¹ï¼

âŒ å¦‚æœä½ è¿”å› `bytes memory` æˆ–å¤šä¸ªåŠ¨æ€å˜é‡ï¼Œç¼–è¯‘å™¨ä¼šä¾èµ–è¿™ä¸ªæŒ‡é’ˆè¿›è¡Œæ–°åˆ†é…ã€‚

âŒ åœ¨ `Yul`ã€`inline` `assembly`ã€æˆ– `ABI` ç¼–ç ä¸­ï¼Œè¿™ä¸ªæŒ‡é’ˆéå¸¸å…³é”®ï¼Œä¸èƒ½ç•™é”™ï¼

ä¸¾ä¸ªç›´è§‚ä¾‹å­ï¼š

```solidity
bytes memory a = at(someAddress);
bytes memory b = new bytes(32);  // ç¼–è¯‘å™¨ä½¿ç”¨ mload(0x40) åˆ†é…æ–°å†…å­˜
```
å¦‚æœæ²¡æ›´æ–° `0x40`ï¼Œb å°±å¯èƒ½ç›´æ¥è¦†ç›– a çš„å†…å®¹ï¼

ğŸ§© åˆ†ä¸¤ç§æƒ…å†µå¯¹æ¯”ï¼š

âœ… æ­£ç¡®åšæ³•ï¼ˆæ›´æ–°äº† 0x40ï¼‰

å›¾ç¤ºï¼šå†…å­˜çŠ¶æ€
```kotlin
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœ°å€       â”‚ å†…å®¹                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x40       â”‚ 0xE0 â† âœ… æ–°çš„ç©ºé—²åœ°å€      â”‚ â† mstore(0x40, ...)
â”‚ 0x80       â”‚ a.length = 45              â”‚ â† o_code
â”‚ 0xA0       â”‚ a.data[0]                  â”‚
â”‚ ...        â”‚ ...                        â”‚
â”‚ 0xE0       â”‚ b.length = 32              â”‚ â† æ–°çš„ b
â”‚ 0x100      â”‚ b.data[0]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
âœ… ä¸€åˆ‡æŒ‰è§„åˆ™å¯¹é½ï¼Œæ•°æ®å¹²å‡€ã€‚

âŒ é”™è¯¯åšæ³•ï¼ˆåˆ é™¤äº† mstore(0x40, ...)ï¼‰

å›¾ç¤ºï¼šå†…å­˜çŠ¶æ€
```kotlin
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœ°å€       â”‚ å†…å®¹                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x40       â”‚ 0x80 â† ğŸ˜± æ²¡æœ‰æ›´æ–°ç©ºé—²æŒ‡é’ˆ â”‚ â† mload(0x40) ä»ä¸ºæ—§å€¼
â”‚ 0x80       â”‚ a.length = 45              â”‚ â† o_code
â”‚ 0xA0       â”‚ a.data[0]                  â”‚
â”‚ ...        â”‚ ...                        â”‚
â”‚ 0x80       â”‚ b.length = 32              â”‚ â† b ä»åŒä¸€åœ°å€åˆ†é…
â”‚ 0xA0       â”‚ b.data[0]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ğŸ’¥ ç»“æœï¼š

- b åˆ†é…çš„å†…å­˜è¦†ç›–äº† a çš„æ•°æ® 
- åç»­è¯»å– a ä¼šå‡ºç°ä¹±ç æˆ–ä¸ä¸€è‡´
- æ›´ä¸¥é‡æ—¶å¯èƒ½å¯¼è‡´åˆçº¦è¡Œä¸ºé”™è¯¯ã€ABI è§£æå¤±è´¥

ğŸ“‰ å¯èƒ½çš„ç°è±¡ï¼š

| è¾“å‡º         | æ­£ç¡®å†™æ³•      | é”™è¯¯å†™æ³•                      |
| ---------- | --------- | ------------------------- |
| `a.length` | æ­£ç¡®å€¼ï¼ˆå¦‚ 45ï¼‰ | è¢« `b.length = 32` è¦†ç›–å˜æˆ 32 |
| `a[0]`     | å­—èŠ‚ç é¦–å­—èŠ‚    | è¢«è¦†ç›–å¯èƒ½å˜ä¸º 0x00              |
| `b[0]`     | æ­£å¸¸å€¼       | æ­£å¸¸å€¼                       |
| å†…å­˜å¸ƒå±€       | åˆ†å¼€        | é‡å ï¼Œæ•°æ®å†²çª                   |

### å‘ä¸Šå¯¹é½åˆ°32å­—èŠ‚è¾¹ç•Œ?
```solidity
and(add(add(size, 0x20), 0x1f), not(0x1f))
```
1. èƒŒæ™¯ï¼šå†…å­˜å¯¹é½
åœ¨ `EVM` é‡Œï¼Œå†…å­˜åˆ†é…é€šå¸¸ä»¥ `32` å­—èŠ‚ ä¸ºå•ä½ï¼ˆä¸€ä¸ªå­—æ§½ `word` å¤§å°ï¼‰ï¼Œå¯¹é½å†…å­˜æ˜¯ä¸ºäº†ï¼š

é¿å…è·¨æ§½è¯»å†™å¸¦æ¥çš„æ€§èƒ½å’Œå®‰å…¨é—®é¢˜

ä¿æŒå†…å­˜å¸ƒå±€è§„èŒƒï¼Œæ–¹ä¾¿ `Solidity` ç¼–è¯‘å™¨å’Œ `ABI` è§£æ

2. å…·ä½“æ“ä½œ
ä¸Šé¢æ“ä½œç­‰ä»·äº `aligned_size = (size + 32 + 31) & (~31)`

åˆ†è§£
- size + 32 ï¼šç»™æ•°æ®åŠ ä¸Š 32 å­—èŠ‚çš„å¤´éƒ¨ç©ºé—´ï¼ˆbytes çš„é•¿åº¦å­—æ®µï¼‰

  | æ“ä½œ        | åŠŸèƒ½æè¿°             |
  | --------- | ---------------- |
  | `+ 0x1f`  | è®©é32çš„å€æ•°â€œå‡‘æ»¡ä¸€æ•´å—â€   |
  | `& ~0x1f` | æ¸…é™¤ä½5ä½ï¼Œç¡®ä¿æ˜¯32çš„å€æ•°å¯¹é½ |
