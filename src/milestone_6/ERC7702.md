# EIP7702

[EIP7702](https://eips.ethereum.org/EIPS/eip-7702) 允许扩展 `EOA` 地址，。

`EOA` 地址扩展的合约 `Code` 为`(0xef0100 || address)`，因为根据[EIP3541](https://eips.ethereum.org/EIPS/eip-3541)不允许部署 0xef 开头的合约。

## GetCodes
`0xef0100` 开头的 `bytecodes` 表示当前地址是扩展的 `EOA` 地址
```solidity
func AccountCodes(address common.Address) string {
	res, err := client.CodeAt(context.Background(), address, nil)
	if err != nil {
		log.Fatal(err)
	}
	log.Printf("codes: %s", hexutil.Encode(res))
	//0xef010080296ff8d1ed46f8e3c7992664d13b833504c2bb
	return hexutil.Encode(res)
}
```

因此，通过下面代码能够判断出当前地址是否是扩展的 `EOA` 地址
```solidity
bytes3 internal constant _DELEGATION_PREFIX = 0xef0100;
function isEOA(address target) internal view returns (bool) {
    bytes memory code = target.code;
    // Add here a comment addressing the normal disclaimers around
    // construction-time issues and zero-length contracts.
    return (code.length == 0 || bytes3(code) == _DELEGATION_PREFIX);
}

/**
 * @dev Returns the address of the delegate if `account` as an EIP-7702 delegation setup, or address(0) otherwise.
     */
function fetchDelegate(address account) internal view returns (address) {
    bytes23 delegation = bytes23(account.code);
    return bytes3(delegation) == EIP7702_PREFIX ? address(bytes20(delegation << 24)) : address(0);
}
```

EOA 扩展后的合约可能执行当前地址的签名校验：
```solidity
abstract contract SignerERC7702 is AbstractSigner {
    /**
     * @dev Validates the signature using the EOA's address (i.e. `address(this)`).
     */
    function _rawSignatureValidation(
        bytes32 hash,
        bytes calldata signature
    ) internal view virtual override returns (bool) {
        (address recovered, ECDSA.RecoverError err, ) = ECDSA.tryRecover(hash, signature);
        return address(this) == recovered && err == ECDSA.RecoverError.NoError;
    }
}
```

## Preference
[https://ethereum.org/roadmap/pectra/7702](https://ethereum.org/roadmap/pectra/7702)

[https://eips.ethereum.org/EIPS/eip-7702]https://eips.ethereum.org/EIPS/eip-7702

[https://etherscan.io/tx/0xebc6f503d3c7cf9560308c8efef69a6c4a993a29224d7a4a4f13ca98d6ae0621](https://etherscan.io/tx/0xebc6f503d3c7cf9560308c8efef69a6c4a993a29224d7a4a4f13ca98d6ae0621)

[https://www.certik.com/zh-CN/resources/blog/pectras-eip-7702-redefining-trust-assumptions-of-externally-owned-accounts](https://www.certik.com/zh-CN/resources/blog/pectras-eip-7702-redefining-trust-assumptions-of-externally-owned-accounts)